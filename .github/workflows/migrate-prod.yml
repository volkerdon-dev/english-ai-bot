name: Migrate PROD

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: "Show alembic heads/current before upgrade"
        required: false
        default: "false"

jobs:
  migrate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install deps
        run: pip install -r requirements.txt

      # (optional) quick visibility before applying
      - name: Alembic info (dry-run)
        if: ${{ inputs.dry_run == 'true' }}
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL_PROD }}
        run: |
          alembic --version
          alembic heads
          alembic current || true

      - name: Upgrade DB
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL_PROD }}
        run: alembic upgrade head

      - name: Show current revision
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL_PROD }}
        run: alembic current

      - name: Verify app_user columns
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL_PROD }}
        run: |
          python - << 'PY'
          import os, sys
          from sqlalchemy import create_engine, text

          database_url = os.environ.get('DATABASE_URL')
          if not database_url:
            print('DATABASE_URL not set', file=sys.stderr)
            sys.exit(1)

          engine = create_engine(database_url)
          with engine.connect() as conn:
            result = conn.execute(text(
              """
              SELECT column_name
              FROM information_schema.columns
              WHERE table_name = 'app_user' AND table_schema = current_schema()
              """
            ))
            columns = {row[0] for row in result}
          expected = {"tg_user_id", "plan", "pro_until", "entitlements"}
          missing = expected - columns
          if missing:
            print('Missing columns: ' + ', '.join(sorted(missing)))
            sys.exit(1)
          print('All expected columns present')
          PY

