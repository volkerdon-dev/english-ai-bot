<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Grammar - EngTrain App</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link rel="stylesheet" href="style.css">
  <style>
    .grammar-section {
      margin: 20px 0;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 10px;
      border-left: 4px solid #007bff;
    }
    
    .grammar-content {
      background: white;
      padding: 20px;
      border-radius: 8px;
      margin: 10px 0;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .grammar-content h3 {
      color: #007bff;
      margin-bottom: 15px;
      border-bottom: 2px solid #e9ecef;
      padding-bottom: 10px;
    }
    
    .grammar-content p {
      margin: 10px 0 12px 0;
      line-height: 1.72;
      font-size: 16.5px;
      letter-spacing: 0.2px;
    }
    
    .grammar-content strong {
      color: #495057;
    }
    
    .grammar-content em {
      color: #6c757d;
      font-style: italic;
      letter-spacing: 0.1px;
    }
    
    .test-section {
      background: #e3f2fd;
      padding: 20px;
      border-radius: 8px;
      margin: 15px 0;
    }
    
    .question {
      background: white;
      padding: 15px;
      margin: 10px 0;
      border-radius: 6px;
      border-left: 3px solid #2196f3;
    }
    
    .options {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin: 10px 0;
    }
    
    .option {
      padding: 8px 12px;
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .option:hover {
      background: #e9ecef;
    }
    
    .option.selected {
      background: #007bff;
      color: white;
    }
    
    .option.correct {
      background: #28a745;
      color: white;
    }
    
    .option.incorrect {
      background: #dc3545;
      color: white;
    }
    
    .explanation {
      background: #fff3cd;
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
      border-left: 3px solid #ffc107;
      display: none;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: #6c757d;
    }
    
    .error {
      background: #f8d7da;
      color: #721c24;
      padding: 15px;
      border-radius: 6px;
      margin: 10px 0;
    }
    
    .back-to-top {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      cursor: pointer;
      display: none;
      z-index: 1000;
    }
    
    .category-nav {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin: 20px 0;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 8px;
    }
    
    .nested-category {
      margin-left: 20px;
      border-left: 3px solid #007bff;
      padding-left: 15px;
    }
    
    .category-btn {
      padding: 10px 16px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 20px;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 15px;
      letter-spacing: 0.2px;
    }
    
    .category-btn:hover {
      background: #0056b3;
    }
    
    .category-btn.active {
      background: #28a745;
    }
  </style>
</head>
<body>
  <div class="header">
    <button onclick="goBack()" class="back-btn">‚Üê –ù–∞–∑–∞–¥</button>
    <h1>üìö Grammar</h1>
    <button onclick="goHome && goHome()" class="home-btn">üè† Home</button>
  </div>

  <div class="content">
    <div id="loading" class="loading">
      <h3>–ó–∞–≥—Ä—É–∑–∫–∞ –≥—Ä–∞–º–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤...</h3>
      <p>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ...</p>
    </div>
    
    <div id="error" class="error" style="display: none;">
      <h3>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</h3>
      <p>–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –≥—Ä–∞–º–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.</p>
    </div>
    
    <div id="grammar-content" style="display: none;">
      <h2>–ì—Ä–∞–º–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ä–∞–∑–¥–µ–ª—ã</h2>
      
      <div class="category-nav" id="category-nav">
        <!-- –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
      </div>
      
      <div class="category-nav" id="exercise-nav" style="margin-top: 10px;">
        <button class="category-btn" onclick="showMainGrammar()">üìö –û—Å–Ω–æ–≤–Ω–∞—è –≥—Ä–∞–º–º–∞—Ç–∏–∫–∞</button>
        <button class="category-btn" onclick="showAdditionalExercises()">üéØ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è</button>
      </div>
      
      <div id="grammar-sections">
        <!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –≥—Ä–∞–º–º–∞—Ç–∏–∫–∏ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–æ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
      </div>
    </div>
  </div>

  <button class="back-to-top" onclick="scrollToTop()" id="back-to-top">‚Üë</button>

  <script>
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
    let telegramReady = false;
    
    if (typeof Telegram !== 'undefined' && Telegram.WebApp) {
      try {
        Telegram.WebApp.ready();
        Telegram.WebApp.expand();
        telegramReady = true;
        console.log('Telegram Web App initialized successfully');
      } catch (error) {
        console.error('Telegram Web App initialization error:', error);
      }
    } else {
      console.log('Running in browser mode');
    }

    let grammarData = {};
    let exercisesData = {};
    let currentCategory = null;
    let testResults = {};
    let currentView = 'main'; // 'main' –∏–ª–∏ 'exercises'

    function goBack() {
      try {
        if (window.history.length > 1) {
          window.history.back();
          return;
        }
      } catch (e) {
        console.warn('history.back failed, fallback to index.html');
      }
      window.location.href = 'index.html#main';
    }

    function goHome() {
      window.location.href = 'index.html#main';
    }
    
    function scrollToTop() {
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
    
    // –ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –∫–Ω–æ–ø–∫—É "–ù–∞–≤–µ—Ä—Ö"
    window.onscroll = function() {
      const backToTop = document.getElementById('back-to-top');
      if (document.body.scrollTop > 500 || document.documentElement.scrollTop > 500) {
        backToTop.style.display = 'block';
      } else {
        backToTop.style.display = 'none';
      }
    };
    
    async function loadGrammarData() {
      try {
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≥—Ä–∞–º–º–∞—Ç–∏–∫–∏
        const grammarResponse = await fetch('grammar_categories_tree.json');
        if (!grammarResponse.ok) {
          throw new Error(`HTTP error! status: ${grammarResponse.status}`);
        }
        grammarData = await grammarResponse.json();
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è
        try {
          const tensesResponse = await fetch('exercises_data/general_practice/tenses_drills.json');
          if (tensesResponse.ok) {
            const tensesData = await tensesResponse.json();
            exercisesData.tenses = tensesData;
          }
          
          const grammarDrillsResponse = await fetch('exercises_data/general_practice/grammar_drills.json');
          if (grammarDrillsResponse.ok) {
            const grammarDrillsData = await grammarDrillsResponse.json();
            exercisesData.grammar = grammarDrillsData;
          }
          
          const constructionsResponse = await fetch('exercises_data/general_practice/constructions_drills.json');
          if (constructionsResponse.ok) {
            const constructionsData = await constructionsResponse.json();
            exercisesData.constructions = constructionsData;
          }
          
          const partsOfSpeechResponse = await fetch('exercises_data/general_practice/parts_of_speech_drills.json');
          if (partsOfSpeechResponse.ok) {
            const partsOfSpeechData = await partsOfSpeechResponse.json();
            exercisesData.partsOfSpeech = partsOfSpeechData;
          }
          
          const sentenceStructureResponse = await fetch('exercises_data/general_practice/sentence_structure_drills.json');
          if (sentenceStructureResponse.ok) {
            const sentenceStructureData = await sentenceStructureResponse.json();
            exercisesData.sentenceStructure = sentenceStructureData;
          }
          
          const commonMistakesResponse = await fetch('exercises_data/general_practice/common_mistakes_drills.json');
          if (commonMistakesResponse.ok) {
            const commonMistakesData = await commonMistakesResponse.json();
            exercisesData.commonMistakes = commonMistakesData;
          }
        } catch (exerciseError) {
          console.warn('Some exercise data could not be loaded:', exerciseError);
        }
        
        displayGrammarContent();
      } catch (error) {
        console.error('Error loading grammar data:', error);
        showError();
      }
    }
    
    function showError() {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('error').style.display = 'block';
    }
    
    function displayGrammarContent() {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('grammar-content').style.display = 'block';
      
      const categoryNav = document.getElementById('category-nav');
      const grammarSections = document.getElementById('grammar-sections');
      
      // –û—á–∏—â–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
      categoryNav.innerHTML = '';
      grammarSections.innerHTML = '';
      
      // –°–æ–∑–¥–∞–µ–º –Ω–∞–≤–∏–≥–∞—Ü–∏—é –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
      Object.keys(grammarData).forEach(category => {
        const btn = document.createElement('button');
        btn.className = 'category-btn';
        btn.textContent = category;
        btn.onclick = () => showCategory(category);
        categoryNav.appendChild(btn);
      });
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
      if (Object.keys(grammarData).length > 0) {
        showCategory(Object.keys(grammarData)[0]);
      }
      
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è
      updateViewButtons();
    }
    
    function showCategory(category) {
      currentCategory = category;
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É
      document.querySelectorAll('.category-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.textContent === category) {
          btn.classList.add('active');
        }
      });
      
      const grammarSections = document.getElementById('grammar-sections');
      grammarSections.innerHTML = '';
      
      const categoryData = grammarData[category];
      
      Object.keys(categoryData).forEach(subcategory => {
        const subcategoryData = categoryData[subcategory];

        if (subcategoryData.type === 'text') {
          // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ç–µ–∫—Å—Ç–æ–≤—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç
          const section = createTextSection(subcategory, subcategoryData.content);
          grammarSections.appendChild(section);
        } else if (subcategoryData.type === 'grammar_test') {
          // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ç–µ—Å—Ç
          const testSection = createTestSection(subcategoryData);
          grammarSections.appendChild(testSection);
        } else if (subcategoryData.type === 'content_from_file') {
          // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∏–∑ —Ñ–∞–π–ª–∞
          const fileSection = createFileContentSection(subcategory, subcategoryData);
          grammarSections.appendChild(fileSection);
        } else if (typeof subcategoryData === 'object' && !subcategoryData.type) {
          // –†–µ–∫—É—Ä—Å–∏–≤–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –≤–ª–æ–∂–µ–Ω–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
          const nestedSection = createNestedSection(subcategory, subcategoryData, false);
          grammarSections.appendChild(nestedSection);
        }
      });
    }
    
    function createTenseCard(title, content) {
      const card = document.createElement('div');
      card.className = 'tense-card';
      card.style.cssText = `
        background: white;
        border-radius: 10px;
        padding: 20px;
        margin: 15px 0;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        cursor: pointer;
        transition: all 0.3s ease;
      `;
      
      card.onmouseover = () => {
        card.style.transform = 'translateY(-2px)';
        card.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
      };
      
      card.onmouseout = () => {
        card.style.transform = 'translateY(0)';
        card.style.boxShadow = '0 2px 8px rgba(0,0,0,0.1)';
      };
      
      const titleElement = document.createElement('h3');
      titleElement.textContent = title;
      titleElement.style.cssText = `
        color: #007bff;
        margin-bottom: 10px;
        font-size: 1.1em;
        letter-spacing: 0.2px;
      `;
      card.appendChild(titleElement);
      
      const contentDiv = document.createElement('div');
      contentDiv.className = 'grammar-content';
      
      // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º markdown-–ø–æ–¥–æ–±–Ω—ã–π —Ç–µ–∫—Å—Ç –≤ HTML
      const formattedContent = formatGrammarContent(content);
      contentDiv.innerHTML = formattedContent;
      
      card.appendChild(contentDiv);
      return card;
    }
    
    function createTextSection(title, content) {
      const section = document.createElement('div');
      section.className = 'grammar-section';
      
      const titleElement = document.createElement('h3');
      titleElement.textContent = title;
      section.appendChild(titleElement);
      
      const contentDiv = document.createElement('div');
      contentDiv.className = 'grammar-content';
      
      // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º markdown-–ø–æ–¥–æ–±–Ω—ã–π —Ç–µ–∫—Å—Ç –≤ HTML
      const formattedContent = formatGrammarContent(content);
      contentDiv.innerHTML = formattedContent;
      
      section.appendChild(contentDiv);
      return section;
    }
    
    function createNestedSection(title, data, isNested = false) {
      const section = document.createElement('div');
      section.className = isNested ? 'grammar-section nested-category' : 'grammar-section';
      
      const titleElement = document.createElement('h3');
      titleElement.textContent = title;
      section.appendChild(titleElement);
      
      Object.keys(data).forEach(item => {
        const itemData = data[item];
        
        if (itemData.type === 'text') {
          const contentSection = createTextSection(item, itemData.content);
          section.appendChild(contentSection);
        } else if (itemData.type === 'grammar_test') {
          const testSection = createTestSection(itemData);
          section.appendChild(testSection);
        } else if (itemData.type === 'content_from_file') {
          // –û–±—Ä–∞–±–æ—Ç–∫–∞ content_from_file —Ç–∏–ø–∞
          const fileContentSection = createFileContentSection(item, itemData);
          section.appendChild(fileContentSection);
        } else if (typeof itemData === 'object' && !itemData.type) {
          // –†–µ–∫—É—Ä—Å–∏–≤–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –≤–ª–æ–∂–µ–Ω–Ω—ã–µ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏
          const nestedSubSection = createNestedSection(item, itemData, true);
          section.appendChild(nestedSubSection);
        }
      });
      
      return section;
    }
    
    function createFileContentSection(title, data) {
      const section = document.createElement('div');
      section.className = 'grammar-section';
      
      const titleElement = document.createElement('h3');
      titleElement.textContent = data.title || title;
      section.appendChild(titleElement);
      
      const contentDiv = document.createElement('div');
      contentDiv.className = 'grammar-content';
      contentDiv.innerHTML = `<p><em>–°–æ–¥–µ—Ä–∂–∏–º–æ–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –∏–∑ —Ñ–∞–π–ª–∞: ${data.file}</em></p>`;
      section.appendChild(contentDiv);
      
      // –ü–æ–ø—ã—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª
      if (data.file) {
        loadFileContent(data.file, contentDiv);
      }
      
      return section;
    }
    
    async function loadFileContent(filename, targetDiv) {
      try {
        const response = await fetch(filename);
        if (response.ok) {
          const fileData = await response.json();
          // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ —Ñ–∞–π–ª–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –µ–≥–æ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
          let content = '';
          if (Array.isArray(fileData)) {
            // –î–ª—è irregular_verbs.json
            if (fileData.length > 0 && fileData[0].base && fileData[0].past && fileData[0].participle) {
              content = `
                <div style="overflow-x: auto;">
                  <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                      <tr style="background: #f8f9fa;">
                        <th style="padding: 8px; border: 1px solid #dee2e6;">Infinitive</th>
                        <th style="padding: 8px; border: 1px solid #dee2e6;">Past Simple</th>
                        <th style="padding: 8px; border: 1px solid #dee2e6;">Past Participle</th>
                        <th style="padding: 8px; border: 1px solid #dee2e6;">–ü–µ—Ä–µ–≤–æ–¥</th>
                      </tr>
                    </thead>
                    <tbody>
                      ${fileData.map(verb => `
                        <tr>
                          <td style="padding: 8px; border: 1px solid #dee2e6;"><strong>${verb.base}</strong></td>
                          <td style="padding: 8px; border: 1px solid #dee2e6;">${verb.past}</td>
                          <td style="padding: 8px; border: 1px solid #dee2e6;">${verb.participle}</td>
                          <td style="padding: 8px; border: 1px solid #dee2e6;">${verb.translation}</td>
                        </tr>
                      `).join('')}
                    </tbody>
                  </table>
                </div>
              `;
            } else {
              // –î–ª—è –¥—Ä—É–≥–∏—Ö –º–∞—Å—Å–∏–≤–æ–≤
              content = fileData.map(item => {
                return `<div style="margin: 5px 0;">${JSON.stringify(item, null, 2)}</div>`;
              }).join('');
            }
          } else {
            content = `<pre>${JSON.stringify(fileData, null, 2)}</pre>`;
          }
          targetDiv.innerHTML = content;
        }
      } catch (error) {
        console.error('Error loading file content:', error);
        targetDiv.innerHTML = `<p><em>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞: ${filename}</em></p>`;
      }
    }
    
    function createTestSection(testData) {
      const section = document.createElement('div');
      section.className = 'test-section';
      
      const title = document.createElement('h3');
      title.textContent = testData.title;
      section.appendChild(title);
      
      const instructions = document.createElement('p');
      instructions.textContent = testData.instructions;
      section.appendChild(instructions);
      
      const testId = `test-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
      
      testData.questions.forEach((question, index) => {
        const questionDiv = document.createElement('div');
        questionDiv.className = 'question';
        
        const questionText = document.createElement('p');
        questionText.innerHTML = `<strong>–í–æ–ø—Ä–æ—Å ${question.question_number}:</strong> ${question.text}`;
        questionDiv.appendChild(questionText);
        
        const optionsDiv = document.createElement('div');
        optionsDiv.className = 'options';
        
        question.options.forEach(option => {
          const optionDiv = document.createElement('div');
          optionDiv.className = 'option';
          optionDiv.textContent = option;
          optionDiv.onclick = () => selectOption(optionDiv, option, question.correct_answer, testId, question.question_number);
          optionsDiv.appendChild(optionDiv);
        });
        
        questionDiv.appendChild(optionsDiv);
        
        const explanationDiv = document.createElement('div');
        explanationDiv.className = 'explanation';
        explanationDiv.innerHTML = `<strong>–û–±—ä—è—Å–Ω–µ–Ω–∏–µ:</strong> ${question.explanation}`;
        questionDiv.appendChild(explanationDiv);
        
        section.appendChild(questionDiv);
      });
      
      return section;
    }
    
    function selectOption(optionElement, selectedOption, correctAnswer, testId, questionNumber) {
      // –£–±–∏—Ä–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –≤—ã–±–æ—Ä—ã –≤ —ç—Ç–æ–º –≤–æ–ø—Ä–æ—Å–µ
      const questionDiv = optionElement.closest('.question');
      questionDiv.querySelectorAll('.option').forEach(opt => {
        opt.classList.remove('selected', 'correct', 'incorrect');
      });
      
      // –û—Ç–º–µ—á–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç
      optionElement.classList.add('selected');
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å
      if (selectedOption === correctAnswer) {
        optionElement.classList.add('correct');
      } else {
        optionElement.classList.add('incorrect');
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç
        questionDiv.querySelectorAll('.option').forEach(opt => {
          if (opt.textContent === correctAnswer) {
            opt.classList.add('correct');
          }
        });
      }
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ
      const explanation = questionDiv.querySelector('.explanation');
      explanation.style.display = 'block';
      
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
      if (!testResults[testId]) {
        testResults[testId] = {};
      }
      testResults[testId][questionNumber] = selectedOption === correctAnswer;
    }
    
    function formatGrammarContent(content) {
      // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º markdown-–ø–æ–¥–æ–±–Ω—ã–π —Å–∏–Ω—Ç–∞–∫—Å–∏—Å –≤ HTML
      let formatted = content
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') // **—Ç–µ–∫—Å—Ç** -> <strong>—Ç–µ–∫—Å—Ç</strong>
        .replace(/\*(.*?)\*/g, '<em>$1</em>') // *—Ç–µ–∫—Å—Ç* -> <em>—Ç–µ–∫—Å—Ç</em>
        .replace(/üß†/g, 'üß† ')
        .replace(/üìå/g, 'üìå ')
        .replace(/üß©/g, 'üß© ')
        .replace(/üîπ/g, 'üîπ ')
        .replace(/üö´/g, 'üö´ ')
        .replace(/‚ùì/g, '‚ùì ')
        .replace(/üß≠/g, 'üß≠ ')
        .replace(/üìé/g, 'üìé ')
        .replace(/üõë/g, 'üõë ')
        .replace(/\n\n/g, '</p><p>') // –î–≤–æ–π–Ω—ã–µ –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫ -> –Ω–æ–≤—ã–µ –ø–∞—Ä–∞–≥—Ä–∞—Ñ—ã
        .replace(/\n/g, '<br>'); // –û–¥–∏–Ω–∞—Ä–Ω—ã–µ –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫ -> <br>
      
      return `<p>${formatted}</p>`;
    }
    
    function addAdditionalExercises() {
      const grammarSections = document.getElementById('grammar-sections');
      
      // –î–æ–±–∞–≤–ª—è–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –ø–æ –≤—Ä–µ–º–µ–Ω–∞–º
      if (exercisesData.tenses) {
        const tensesSection = document.createElement('div');
        tensesSection.className = 'grammar-section';
        
        const tensesTitle = document.createElement('h3');
        tensesTitle.textContent = 'üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –ø–æ –≤—Ä–µ–º–µ–Ω–∞–º';
        tensesSection.appendChild(tensesTitle);
        
        exercisesData.tenses.forEach(topic => {
          const topicSection = createExerciseSection(topic);
          tensesSection.appendChild(topicSection);
        });
        
        grammarSections.appendChild(tensesSection);
      }
      
      // –î–æ–±–∞–≤–ª—è–µ–º —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –ø–æ —á–∞—Å—Ç—è–º —Ä–µ—á–∏
      if (exercisesData.partsOfSpeech) {
        const partsSection = document.createElement('div');
        partsSection.className = 'grammar-section';
        
        const partsTitle = document.createElement('h3');
        partsTitle.textContent = 'üî§ –£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –ø–æ —á–∞—Å—Ç—è–º —Ä–µ—á–∏';
        partsSection.appendChild(partsTitle);
        
        exercisesData.partsOfSpeech.forEach(topic => {
          const topicSection = createExerciseSection(topic);
          partsSection.appendChild(topicSection);
        });
        
        grammarSections.appendChild(partsSection);
      }
      
      // –î–æ–±–∞–≤–ª—è–µ–º —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –ø–æ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º
      if (exercisesData.constructions) {
        const constructionsSection = document.createElement('div');
        constructionsSection.className = 'grammar-section';
        
        const constructionsTitle = document.createElement('h3');
        constructionsTitle.textContent = 'üèóÔ∏è –£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –ø–æ –≥—Ä–∞–º–º–∞—Ç–∏—á–µ—Å–∫–∏–º –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º';
        constructionsSection.appendChild(constructionsTitle);
        
        exercisesData.constructions.forEach(topic => {
          const topicSection = createExerciseSection(topic);
          constructionsSection.appendChild(topicSection);
        });
        
        grammarSections.appendChild(constructionsSection);
      }
      
      // –î–æ–±–∞–≤–ª—è–µ–º —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –ø–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π
      if (exercisesData.sentenceStructure) {
        const structureSection = document.createElement('div');
        structureSection.className = 'grammar-section';
        
        const structureTitle = document.createElement('h3');
        structureTitle.textContent = 'üìù –£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –ø–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π';
        structureSection.appendChild(structureTitle);
        
        exercisesData.sentenceStructure.forEach(topic => {
          const topicSection = createExerciseSection(topic);
          structureSection.appendChild(topicSection);
        });
        
        grammarSections.appendChild(structureSection);
      }
      
      // –î–æ–±–∞–≤–ª—è–µ–º —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –ø–æ —Ç–∏–ø–∏—á–Ω—ã–º –æ—à–∏–±–∫–∞–º
      if (exercisesData.commonMistakes) {
        const mistakesSection = document.createElement('div');
        mistakesSection.className = 'grammar-section';
        
        const mistakesTitle = document.createElement('h3');
        mistakesTitle.textContent = '‚ö†Ô∏è –£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –ø–æ —Ç–∏–ø–∏—á–Ω—ã–º –æ—à–∏–±–∫–∞–º';
        mistakesSection.appendChild(mistakesTitle);
        
        exercisesData.commonMistakes.forEach(topic => {
          const topicSection = createExerciseSection(topic);
          mistakesSection.appendChild(topicSection);
        });
        
        grammarSections.appendChild(mistakesSection);
      }
    }
    
    function createExerciseSection(topic) {
      const section = document.createElement('div');
      section.className = 'test-section';
      
      const title = document.createElement('h4');
      title.textContent = topic.topic;
      section.appendChild(title);
      
      const instructions = document.createElement('p');
      instructions.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç –æ—Ç–≤–µ—Ç–∞ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è.';
      section.appendChild(instructions);
      
      const testId = `exercise-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
      
      topic.questions.forEach((question, index) => {
        const questionDiv = document.createElement('div');
        questionDiv.className = 'question';
        
        const questionText = document.createElement('p');
        questionText.innerHTML = `<strong>–í–æ–ø—Ä–æ—Å ${index + 1}:</strong> ${question.text}`;
        questionDiv.appendChild(questionText);
        
        const optionsDiv = document.createElement('div');
        optionsDiv.className = 'options';
        
        question.options.forEach(option => {
          const optionDiv = document.createElement('div');
          optionDiv.className = 'option';
          optionDiv.textContent = option;
          optionDiv.onclick = () => selectOption(optionDiv, option, question.correct_answer, testId, index + 1);
          optionsDiv.appendChild(optionDiv);
        });
        
        questionDiv.appendChild(optionsDiv);
        
        const explanationDiv = document.createElement('div');
        explanationDiv.className = 'explanation';
        explanationDiv.innerHTML = `<strong>–û–±—ä—è—Å–Ω–µ–Ω–∏–µ:</strong> ${question.explanation}`;
        questionDiv.appendChild(explanationDiv);
        
        section.appendChild(questionDiv);
      });
      
      return section;
    }
    
    function showMainGrammar() {
      currentView = 'main';
      updateViewButtons();
      
      const grammarSections = document.getElementById('grammar-sections');
      grammarSections.innerHTML = '';
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Å–Ω–æ–≤–Ω—É—é –≥—Ä–∞–º–º–∞—Ç–∏–∫—É
      if (Object.keys(grammarData).length > 0) {
        showCategory(Object.keys(grammarData)[0]);
      }
    }
    
    function showAdditionalExercises() {
      currentView = 'exercises';
      updateViewButtons();
      
      const grammarSections = document.getElementById('grammar-sections');
      grammarSections.innerHTML = '';
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è
      addAdditionalExercises();
    }
    
    function updateViewButtons() {
      const mainBtn = document.querySelector('#exercise-nav button:first-child');
      const exercisesBtn = document.querySelector('#exercise-nav button:last-child');
      
      if (currentView === 'main') {
        mainBtn.classList.add('active');
        exercisesBtn.classList.remove('active');
      } else {
        mainBtn.classList.remove('active');
        exercisesBtn.classList.add('active');
      }
    }
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    window.onload = function() {
      loadGrammarData();
    };
  </script>
</body>
</html> 